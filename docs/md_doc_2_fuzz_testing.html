<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Halide: Fuzz testing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Halide<span id="projectnumber">&#160;19.0.0</span>
   </div>
   <div id="projectbrief">Halide compiler and libraries</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_doc_2_fuzz_testing.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Fuzz testing</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="fuzz-testing"></a></p>
<p><a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> has a set of fuzz-testing harnesses that can be used to find those tricky to find, edge cases and bugs that would otherwise not be caught by a regular unit-testing suite. At the moment these fuzz-tests are housed in the <code>test/fuzz</code> directory. The fuzz testing suite use the common, <a href="https://www.llvm.org/docs/LibFuzzer.html">libfuzzer</a> interface for fuzz-tests.</p>
<h1><a class="anchor" id="building-fuzz-tests"></a>
Building fuzz tests</h1>
<p>Fuzz testing requires specific instrumentation across the entire build; to do this we make use of a fuzzing-specific-toolchain/preset. e.g.</p>
<div class="fragment"><div class="line">cmake -B build --preset linux-x64-fuzzer -DLLVM_ROOT=/path/to/llvminstall</div>
<div class="line">cmake --build ./build -j$(nproc)</div>
</div><!-- fragment --><p>Note that the LLVM install that you use must be built with <code>-D LLVM_ENABLE_RUNTIMES="compiler-rt"</code> set if you want to build the fuzzer tests (failing to do so will fail at configure time); not all prebuilt LLVM installs include this, so you may need to build LLVM from source to run the fuzz tests locally.</p>
<h1><a class="anchor" id="using-the-fuzz-harnesses"></a>
Using the fuzz-harnesses</h1>
<p>Fuzz-testing harnesses are a little different to a more traditional unit-test and don't have a definitive end of test. In other words, a fuzz test will run:</p><ul>
<li>for an infinite amount of time (the default),</li>
<li>for a user specified maximum amount of time,</li>
<li>until the fuzzer finds a bug and crashes,</li>
<li>you manually kill the process e.g. (ctrl-C).</li>
</ul>
<p>Once you have built the fuzz testing suite using the commands listed above you can list the fuzz testing harnesses using the command:</p>
<div class="fragment"><div class="line">ls ./build/test/fuzz/fuzz_*</div>
</div><!-- fragment --><p>To run a fuzzer simply run the fuzz-testing harness with no arguments. e.g.</p>
<p><code>./build/test/fuzz/fuzz_simplify</code></p>
<p>By default this will run the fuzz test on a single core and discard whatever. temporary corpus is created.</p>
<p>To reuse a given corpus (recommended) create a new directory to store the corpus generated by your fuzz testing harness and pass that directory into your fuzzer e.g.</p>
<div class="fragment"><div class="line">mkdir fuzz_simplify_corpus -p</div>
<div class="line">./build/test/fuzz/fuzz_simplify fuzz_simplify_corpus</div>
</div><!-- fragment --><p>This will save the state of the fuzzer between runs, this way any progress that your fuzzer makes improving code-coverage will remain persistent on your disk.</p>
<p>Up until this point the fuzzer has only been running on a single core. To speed things up a little, let's run the fuzzer in parallel across all available cores on our machine.</p>
<div class="fragment"><div class="line">./build/test/fuzz/fuzz_simplify fuzz_simplify_corpus -fork=$(nproc)</div>
</div><!-- fragment --><h1><a class="anchor" id="reproducing-crashes"></a>
Reproducing crashes</h1>
<p>An important part of fuzz testing is reproducing the crashing input. To handle this, a libfuzzer-based fuzz harness will create a crash file whenever the fuzzer exits unexpectedly. This will look something like:</p>
<p><code>crash-&lt;some_random_hash&gt;</code></p>
<p>To reproduce a crash we simply rerun our fuzz harness with our crash file as the first argument.</p>
<p><code>./build/test/fuzz/fuzz_simplify crash-&lt;some_random_hash&gt;</code></p>
<p>So long as your fuzz harness and library are deterministic this should reproduce the original crash.</p>
<h1><a class="anchor" id="adding-new-fuzz-tests"></a>
Adding new fuzz tests</h1>
<p>A bare-bones fuzzer will look something like the following: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stddef.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;my_library.h&gt;</span></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">int</span> LLVMFuzzerTestOneInput(<span class="keyword">const</span> <a class="code hl_typedef" href="runtime__internal_8h.html#a5f44f30d12f5ed554d1bdb9825df6137">uint8_t</a> *data, <span class="keywordtype">size_t</span> size) {</div>
<div class="line">  <span class="comment">// Randomly throw data at our function and hope it doesn&#39;t crash.</span></div>
<div class="line">  foo(data, size);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aruntime__internal_8h_html_a5f44f30d12f5ed554d1bdb9825df6137"><div class="ttname"><a href="runtime__internal_8h.html#a5f44f30d12f5ed554d1bdb9825df6137">uint8_t</a></div><div class="ttdeci">unsigned __INT8_TYPE__ uint8_t</div><div class="ttdef"><b>Definition</b> <a href="runtime__internal_8h_source.html#l00029">runtime_internal.h:29</a></div></div>
</div><!-- fragment --><p>This assumes that our function foo takes in a buffer and the size of said buffer. But in many cases we would like to make use of more structured data. e.g. a string or a vector of integers etc. Thankfully libfuzzer provides a handy helper to convert a raw buffer into common structured data types, the <a href="https://github.com/llvm/llvm-project/blob/main/compiler-rt/include/fuzzer/FuzzedDataProvider.h">FuzzedDataProvider class</a>. For examples on how to use this class see <code>test/fuzz/simplify.cpp</code>.</p>
<h1><a class="anchor" id="other-useful-materials"></a>
Other useful materials</h1>
<ul>
<li><a href="https://www.llvm.org/docs/LibFuzzer.html">The official libfuzzer docs</a></li>
<li><a href="https://github.com/google/fuzzing/blob/master/tutorial/libFuzzerTutorial.md">The libfuzzer tutorial</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
