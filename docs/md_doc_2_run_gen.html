<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Halide: Running and Benchmarking Halide Generators</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Halide<span id="projectnumber">&#160;19.0.0</span>
   </div>
   <div id="projectbrief">Halide compiler and libraries</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_doc_2_run_gen.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Running and Benchmarking Halide Generators</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="running-and-benchmarking-halide-generators"></a></p>
<h1><a class="anchor" id="overview"></a>
Overview</h1>
<p><code>RunGen</code> is a simple(ish) wrapper that allows an arbitrary Generator to be built into a single executable that can be run directly from bash, without needing to wrap it in your own custom main() driver. It also implements a rudimentary benchmarking and memory-usage functionality.</p>
<p>If you use the standard CMake rules for Generators, you get RunGen functionality automatically. (If you use Make, you might need to add an extra rule or two to your Makefile; all the examples in <code>apps/</code> already have these rules.)</p>
<p>For every <code>halide_library</code> (or <code>halide_library_from_generator</code>) rule, there is an implicit <code>name.rungen</code> rule that generates an executable that wraps the Generator library:</p>
<div class="fragment"><div class="line"># In addition to defining a static library named &quot;local_laplacian&quot;, this rule</div>
<div class="line"># also implicitly defines an executable target named &quot;local_laplacian.rungen&quot;</div>
<div class="line">halide_library(</div>
<div class="line">    local_laplacian</div>
<div class="line">    SRCS local_laplacian_generator.cc</div>
<div class="line">)</div>
</div><!-- fragment --><p>You can build and run this like any other executable:</p>
<div class="fragment"><div class="line">$ make bin/local_laplacian.rungen &amp;&amp; ./bin/local_laplacian.rungen</div>
<div class="line">Usage: local_laplacian.rungen argument=value [argument=value... ] [flags]</div>
<div class="line">...typical &quot;usage&quot; text...</div>
</div><!-- fragment --><p>To be useful, you need to pass in values for the Generator's inputs (and locations for the output(s)) on the command line, of course. You can use the <code>--describe</code> flag to see the names and expected types:</p>
<div class="fragment"><div class="line"># (&#39;make bin/local_laplacian.rungen &amp;&amp; &#39; prefix omitted henceforth for clarity)</div>
<div class="line">$ ./bin/local_laplacian.rungen --describe</div>
<div class="line">Filter name: &quot;local_laplacian&quot;</div>
<div class="line">  Input &quot;input&quot; is of type Buffer&lt;uint16&gt; with 3 dimensions</div>
<div class="line">  Input &quot;levels&quot; is of type int32</div>
<div class="line">  Input &quot;alpha&quot; is of type float32</div>
<div class="line">  Input &quot;beta&quot; is of type float32</div>
<div class="line">  Output &quot;local_laplacian&quot; is of type Buffer&lt;uint16&gt; with 3 dimensions</div>
</div><!-- fragment --><p>Warning: Outputs may have <code>$X</code> (where <code>X</code> is a small integer) appended to their names in some cases (or, in the case of Generators that don't explicitly declare outputs via <code>Output&lt;&gt;</code>, an autogenerated name of the form <code>fX</code>). If this happens, don't forget to escape the <code>$</code> with a backslash as necessary. These are both bugs we intend to fix; see <a href="https://github.com/halide/Halide/issues/2194">https://github.com/halide/Halide/issues/2194</a></p>
<p>As a convenience, there is also an implicit target that builds-and-runs, named simply "NAME.run":</p>
<div class="fragment"><div class="line"># This is equivalent to &quot;make bin/local_laplacian.rungen &amp;&amp; ./bin/local_laplacian.rungen&quot;</div>
<div class="line">$ make bin/local_laplacian.run</div>
<div class="line">Usage: local_laplacian.rungen argument=value [argument=value... ] [flags]</div>
<div class="line"> </div>
<div class="line"># To pass arguments to local_laplacian.rungen, set the RUNARGS var:</div>
<div class="line">$ make bin/local_laplacian.run RUNARGS=--describe</div>
<div class="line">Filter name: &quot;local_laplacian&quot;</div>
<div class="line">  Input &quot;input&quot; is of type Buffer&lt;uint16&gt; with 3 dimensions</div>
<div class="line">  Input &quot;levels&quot; is of type int32</div>
<div class="line">  Input &quot;alpha&quot; is of type float32</div>
<div class="line">  Input &quot;beta&quot; is of type float32</div>
<div class="line">  Output &quot;local_laplacian&quot; is of type Buffer&lt;uint16&gt; with 3 dimensions</div>
</div><!-- fragment --><p>Inputs are specified as <code>name=value</code> pairs, in any order. Scalar inputs are specified the typical text form, while buffer inputs (and outputs) are specified via paths to image files. RunGen currently can read/write image files in any format supported by halide_image_io.h; at this time, that means .png, .jpg, .ppm, .pgm, and .tmp formats. (We plan to add .tiff and .mat (level 5) in the future.)</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen input=../images/rgb_small16.png levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
<div class="line">$ display /tmp/out.png</div>
</div><!-- fragment --><p>You can also specify any scalar input as <code>default</code> or <code>estimate</code>, which will use the default value specified for the input, or the value specified by <code>set_estimate</code> for that input. (If the relevant value isn't set for that input, a runtime error occurs.)</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen input=../images/rgb_small16.png levels=8 alpha=estimate beta=default output=/tmp/out.png</div>
<div class="line">$ display /tmp/out.png</div>
</div><!-- fragment --><p>If you specify an input or output file format that doesn't match the required type/dimensions for an argument (e.g., using an 8-bit PNG for an Input&lt;float&gt;, or a grayscale image for a 3-dimensional input), RunGen will try to coerce the inputs to something sensible; that said, it's hard to always get this right, so warnings are <b>always</b> issued whenever an input or output is modified in any way.</p>
<div class="fragment"><div class="line"># This filter expects a 16-bit RGB image as input, but we&#39;re giving it an 8-bit grayscale image:</div>
<div class="line">$ ./bin/local_laplacian.rungen input=../images/gray.png levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
<div class="line">Warning: Image for Input &quot;input&quot; has 2 dimensions, but this argument requires at least 3 dimensions: adding dummy dimensions of extent 1.</div>
<div class="line">Warning: Image loaded for argument &quot;input&quot; is type uint8 but this argument expects type uint16; data loss may have occurred.</div>
</div><!-- fragment --><p>By default, we try to guess a suitable size for the output image(s), based mainly on the size of the input images (if any); you can also specify explicit output extents. (Note that output_extents are subject to constraints already imposed by the particular Generator's logic, so arbitrary values for &ndash;output_extents may produce runtime errors.)</p>
<div class="fragment"><div class="line"># Constrain output extents to 100x200x3</div>
<div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] input=../images/rgb_small16.png levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>Sometimes you don't care what the particular element values for an input are (e.g. for benchmarking), and you just want an image of a particular size; in that case, you can use the <code>zero:[]</code> pseudo-file; it infers the <em>type</em> from the Generator, and inits every element to zero:</p>
<div class="fragment"><div class="line"># Input is a 3-dimensional image with extent 123, 456, and 3</div>
<div class="line"># (bluring an image of all zeroes isn&#39;t very interesting, of course)</div>
<div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] input=zero:[123,456,3] levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>You can also specify arbitrary (nonzero) constants:</p>
<div class="fragment"><div class="line"># Input is a 3-dimensional image with extent 123, 456, and 3,</div>
<div class="line"># filled with a constant value of 42</div>
<div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] input=constant:42:[123,456,3] levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>Similarly, you can create identity images where only the diagonal elements are 1-s (rest are 0-s) by invoking <code>identity:[]</code>. Diagonal elements are defined as those whose first two coordinates are equal.</p>
<p>There's also a <code>random:SEED:[]</code> pseudo-file, which fills the image with uniform noise based on a specific random-number seed:</p>
<div class="fragment"><div class="line"># Input is a 3-dimensional image with extent 123, 456, and 3</div>
<div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] input=random:42:[123,456,3] levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>Instead of specifying an explicit set of extents for a pseudo-input, you can use the string <code>auto</code>, which will run a bounds query to choose a legal set of extents for that input given the known output extents. (This is only useful when used in conjunction with the <code>--output_extents</code> flag.)</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] input=zero:auto levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>You can also specify <code>estimate</code> for the extents, which will use the estimate values provided, typically (but not necessarily) for auto_schedule. (If there aren't estimates for all of the buffer's dimensions, a runtime error occurs.)</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] input=zero:auto levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>You can combine the two and specify <code>estimate_then_auto</code> for the extents, which will attempt to use the estimate values; if a given input buffer has no estimates, it will fall back to the bounds-query result for that input:</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] input=zero:estimate_then_auto levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>Similarly, you can use <code>estimate</code> for <code>--output_extents</code>, which will use the estimate values for each output. (If there aren't estimates for all of the outputs, a runtime error occurs.)</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --output_extents=estimate input=zero:auto levels=8 alpha=1 beta=1 output=/tmp/out.png</div>
</div><!-- fragment --><p>If you don't want to explicitly specify all (or any!) of the input values, you can use the <code>--default_input_buffers</code> and <code>--default_input_scalars</code> flags, which provide wildcards for any omitted inputs:</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --output_extents=[100,200,3] --default_input_buffers=random:0:auto --default_input_scalars=estimate output=/tmp/out.png</div>
</div><!-- fragment --><p>In this case, all input buffers will be sized according to bounds query, and filled with a random seed; all input scalars will be initialized to their declared default values. (If they have no declared default value, a zero of the appropriate type will be used.)</p>
<p>Note: <code>--default_input_buffers</code> can produce surprising sizes! For instance, any input that uses <code>BoundaryConditions::repeat_edge</code> to wrap itself can legally be set to almost any size, so you may legitimately get an input with extent=1 in all dimensions; whether this is useful to you or not depends on the code. It's highly recommended you do testing with the <code>--verbose</code> flag (which will log the calculated sizes) to reality-check that you are getting what you expect, especially for benchmarking.</p>
<p>A common case (especially for benchmarking) is to specify using estimates for all inputs and outputs; for this, you can specify <code>--estimate_all</code>, which is just a shortcut for <code>--default_input_buffers=estimate_then_auto --default_input_scalars=estimate --output_extents=estimate</code>.</p>
<h1><a class="anchor" id="benchmarking"></a>
Benchmarking</h1>
<p>To run a benchmark, use the <code>--benchmarks=all</code> flag:</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --benchmarks=all input=zero:[1920,1080,3] levels=8 alpha=1 beta=1 --output_extents=[100,200,3]</div>
<div class="line">Benchmark for local_laplacian produces best case of 0.0494629 sec/iter, over 3 blocks of 10 iterations.</div>
<div class="line">Best output throughput is 39.9802 mpix/sec.</div>
</div><!-- fragment --><p>You can use <code>--default_input_buffers</code> and <code>--default_input_scalars</code> here as well:</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --benchmarks=all --default_input_buffers --default_input_scalars --output_extents=estimate</div>
<div class="line">Benchmark for local_laplacian produces best case of 0.0494629 sec/iter, over 3 blocks of 10 iterations.</div>
<div class="line">Best output throughput is 39.9802 mpix/sec.</div>
</div><!-- fragment --><p>Note: <code>halide_benchmark.h</code> is known to be inaccurate for GPU filters; see <a href="https://github.com/halide/Halide/issues/2278">https://github.com/halide/Halide/issues/2278</a></p>
<h1><a class="anchor" id="measuring-memory-usage"></a>
Measuring Memory Usage</h1>
<p>To track memory usage, use the <code>--track_memory</code> flag, which measures the high-water-mark of CPU memory usage.</p>
<div class="fragment"><div class="line">$ ./bin/local_laplacian.rungen --track_memory input=zero:[1920,1080,3] levels=8 alpha=1 beta=1 --output_extents=[100,200,3]</div>
<div class="line">Maximum Halide memory: 82688420 bytes for output of 1.97754 mpix.</div>
</div><!-- fragment --><p>Warning: <code>--track_memory</code> may degrade performance; don't combine it with <code>--benchmark</code> or expect meaningful timing measurements when using it.</p>
<h1><a class="anchor" id="using-rungen-in-make"></a>
Using RunGen in Make</h1>
<p>To add support for RunGen to your Makefile, you need to add rules something like this (see <code>apps/support/Makefile.inc</code> for an example):</p>
<div class="fragment"><div class="line">HALIDE_DISTRIB ?= /path/to/halide/distrib/folder</div>
<div class="line"> </div>
<div class="line">$(BIN)/RunGenMain.o: $(HALIDE_DISTRIB)/tools/RunGenMain.cpp</div>
<div class="line">  @mkdir -p $(@D)</div>
<div class="line">  @$(CXX) -c $&lt; $(CXXFLAGS) $(LIBPNG_CXX_FLAGS) $(LIBJPEG_CXX_FLAGS) -I$(BIN) -o $@</div>
<div class="line"> </div>
<div class="line">.PRECIOUS: $(BIN)/%.rungen</div>
<div class="line">$(BIN)/%.rungen: $(BIN)/%.a $(BIN)/%.registration.cpp $(BIN)/RunGenMain.o</div>
<div class="line">  $(CXX) $(CXXFLAGS) $^ -o $@ $(LIBPNG_LIBS) $(LIBJPEG_LIBS) $(LDFLAGS)</div>
<div class="line"> </div>
<div class="line">RUNARGS ?=</div>
<div class="line"> </div>
<div class="line">$(BIN)/%.run: $(BIN)/%.rungen</div>
<div class="line">  @$(CURDIR)/$&lt; $(RUNARGS)</div>
</div><!-- fragment --><p>Note that the <code>%.registration.cpp</code> file is created by running a generator and specifying <code>registration</code> in the comma-separated list of files to emit; these are also generated by default if <code>-e</code> is not used on the generator command line.</p>
<h1><a class="anchor" id="known-issues--caveats"></a>
Known Issues &amp; Caveats</h1>
<ul>
<li>If your Generator uses <code>define_extern()</code>, you must have all link-time dependencies declared properly via <code>FILTER_DEPS</code>; otherwise, you'll fail to link.</li>
<li>The code does its best to detect when inputs or outputs need to be chunky/interleaved (rather than planar), but in unusual cases it might guess wrong; if your Generator uses buffers with unusual stride setups, RunGen might fail at runtime. (If this happens, please file a bug!)</li>
<li>The code for deducing good output sizes is rudimentary and needs to be smartened; it will sometimes make bad decisions which will prevent the filter from executing. (If this happens, please file a bug!) </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
