<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Halide: WebGPU support for Halide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Halide<span id="projectnumber">&#160;19.0.0</span>
   </div>
   <div id="projectbrief">Halide compiler and libraries</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_doc_2_web_g_p_u.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">WebGPU support for Halide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="webgpu-support-for-halide"></a></p>
<p><a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> has work-in-progress support for generating and running WebGPU shaders. This can be used in conjunction with the WebAssembly backend to bring GPU-accelerated <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> pipelines to the web.</p>
<p>As the first version of the WebGPU standard is itself still being developed, <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a>'s support has some limitations and may only work with certain browsers and versions of Emscripten.</p>
<h1><a class="anchor" id="known-limitations"></a>
Known limitations</h1>
<p>The following is a non-comprehensive list of known limitations:</p>
<ul>
<li>Only 32-bit integers and floats have efficient support.<ul>
<li>8-bit and 16-bit integers are implemented using emulation. Future extensions to WGSL will allow them to be implemented more efficiently.</li>
<li>64-bit integers and floats will likely remain unsupported until WGSL gains extensions to support them.</li>
</ul>
</li>
<li>Wrapping native device buffer handles is not yet implemented.</li>
<li>You must use CMake/CTest to build/test <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> for WebGPU; using the Makefile is not supported for WebGPU testing (and probably never will be).</li>
</ul>
<p>In addition to these functional limitations, the performance of the WebGPU backend has not yet been evaluated, and so optimizations in the runtime or device codegen may be required before it becomes profitable to use.</p>
<h1><a class="anchor" id="running-with-webassembly-via-emscripten-hl_targetwasm-32-wasmrt-webgpu"></a>
Running with WebAssembly via Emscripten: <code>HL_TARGET=wasm-32-wasmrt-webgpu</code></h1>
<blockquote class="doxtable">
<p>&zwj;<em>Tested with top-of-tree Emscripten as of 2023-02-23, against Chrome v113.</em> </p>
</blockquote>
<p><a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> can generate WebGPU code that can be integrated with WASM code using Emscripten.</p>
<p>When invoking <code>emcc</code> to link Halide-generated objects, include these flags: <code>-s USE_WEBGPU=1 -s ASYNCIFY</code>.</p>
<p>Tests that use AOT compilation can be run using a native WebGPU implementation that has Node.js bindings, such as <a href="https://dawn.googlesource.com/dawn/">Dawn</a>. You must set an environment variable named <code>HL_WEBGPU_NODE_BINDINGS</code> that has an absolute path to the bindings to run these tests, e.g. <code>HL_WEBGPU_NODE_BINDINGS=/path/to/dawn.node</code>.</p>
<p>See <a class="el" href="#setting-up-dawn">below</a> for instructions on building the Dawn Node.js bindings.</p>
<p>JIT compilation is not supported when using WebGPU with WASM.</p>
<h1><a class="anchor" id="running-natively-hl_targethost-webgpu"></a>
Running natively: <code>HL_TARGET=host-webgpu</code></h1>
<blockquote class="doxtable">
<p>&zwj;<em>Tested with top-of-tree Dawn as of 2023-11-27 [commit b5d38fc7dc2a20081312c95e379c4a918df8b7d4].</em> </p>
</blockquote>
<p>For testing purposes, <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> can also target native WebGPU libraries, such as <a href="https://dawn.googlesource.com/dawn/">Dawn</a> or <a href="https://github.com/gfx-rs/wgpu">wgpu</a>. This is currently the only path that can run the JIT correctness tests. See <a class="el" href="#setting-up-dawn">below</a> for instructions on building Dawn.</p>
<blockquote class="doxtable">
<p>&zwj;Note that as of 2023-11-27, wgpu is not supported due to <a href="https://github.com/gfx-rs/wgpu/issues/1762">lacking <code>override</code> support for WGSL</a> which we require &gt; in order to set GPU block sizes. </p>
</blockquote>
<p>When targeting WebGPU with a native target, <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> defaults to looking for a build of Dawn (with several common names and suffixes); you can override this by setting the <code>HL_WEBGPU_NATIVE_LIB</code> environment variable to the absolute path to the library you want.</p>
<p>Note that it is explicitly legal to define both <code>HL_WEBGPU_NATIVE_LIB</code> and <code>HL_WEBGPU_NODE_BINDINGS</code> at the same time; the correct executable environment will be selected based on the <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> target specified.</p>
<p>Note that it is explicitly legal to specify both WEBGPU_NATIVE_LIB and WEBGPU_NODE_BINDINGS for the same build; the correct executable environment will be selected based on the <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> target specified.</p>
<h1><a class="anchor" id="setting-up-dawn"></a>
Setting up Dawn</h1>
<p>Building Dawn's Node.js bindings currently requires using CMake.</p>
<p>First, <a href="https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up">install <code>depot_tools</code></a> and add it to the <code>PATH</code> environment variable.</p>
<p>Next, get Dawn and its dependencies: </p><pre class="fragment"># Clone the repo
git clone https://dawn.googlesource.com/dawn
cd dawn

# Bootstrap the gclient configuration with Node.js bindings enabled
cp scripts/standalone-with-node.gclient .gclient

# Fetch external dependencies and toolchains with gclient
gclient sync

# Other dependencies that must be installed manually:
# - golang
</pre><p>Finally, build Dawn, enabling both the Node.js bindings and shared libraries: </p><pre class="fragment">mkdir -p &lt;build_dir&gt;
cd &lt;build_dir&gt;

cmake &lt;dawn_root_dir&gt; -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DDAWN_BUILD_NODE_BINDINGS=1 \
    -DDAWN_ENABLE_PIC=1 \
    -DBUILD_SHARED_LIBS=ON

ninja dawn.node webgpu_dawn
</pre><p>This will produce the following artifacts:</p><ul>
<li>Node.js bindings: <code>&lt;build_dir&gt;/dawn.node</code></li>
<li>Native library: <code>&lt;build_dir&gt;/src/dawn/native/libwebgpu_dawn.{so,dylib,dll}</code></li>
</ul>
<p>These paths can then be used for the <code>HL_WEBGPU_NODE_BINDINGS</code> and <code>HL_WEBGPU_NATIVE_LIB</code> environment variables when using <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a>.</p>
<h1><a class="anchor" id="updating-mini_webgpuh"></a>
Updating mini_webgpu.h</h1>
<p>The recommended method for updating <code><a class="el" href="mini__webgpu_8h.html">mini_webgpu.h</a></code> is to copy the <code>gen/include/dawn/webgpu.h</code> file from the Dawn build directory, then:</p><ul>
<li>Restore the <code>// clang-format {off,on}</code> lines.</li>
<li>Comment out the <code>#include &lt;std*&gt;</code> lines.</li>
<li>Remove the <code>void</code> parameter from the <code>WGPUProc</code> declaration.</li>
</ul>
<p>This guarantees a version of the WebGPU header that is compatible with Dawn. When the native API eventually stabilizes, it should be possible to obtain a header from the <code>webgpu-native</code> GitHub organization that will be compatible with Dawn, wgpu, and Emscripten. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
