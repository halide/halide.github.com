<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Halide: Vulkan Support for Halide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Halide<span id="projectnumber">&#160;19.0.0</span>
   </div>
   <div id="projectbrief">Halide compiler and libraries</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_doc_2_vulkan.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Vulkan Support for Halide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="vulkan-support-for-halide"></a></p>
<p><a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> supports the Khronos Vulkan framework as a compute API backend for GPU-like devices, and compiles directly to a binary SPIR-V representation as part of its code generation before submitting it to the Vulkan API. Both JIT and AOT usage are supported via the <code>vulkan</code> target flag (e.g. <code>HL_JIT_TARGET=host-vulkan</code>).</p>
<p>Vulkan support is actively under development, and considered <em>BETA</em> quality at this stage. Tests are passing, but performance tuning and user testing is needed to identify potential issues before rolling this into production. <br  />
</p>
<p>See <a class="el" href="#current-status">below</a> for details.</p>
<h1><a class="anchor" id="compiling-halide-wvulkan-support"></a>
Compiling Halide w/Vulkan Support</h1>
<p>You'll need to configure <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> and enable the cmake option TARGET_VULKAN (which is now ON by default).</p>
<p>For example, on Linux &amp; OSX:</p>
<div class="fragment"><div class="line">% cmake -G Ninja -DTARGET_VULKAN=ON -DCMAKE_BUILD_TYPE=Release -DLLVM_DIR=$LLVM_ROOT/lib/cmake/llvm </div>
<div class="line">% cmake --build build --config Release</div>
</div><!-- fragment --><p>On Windows, you may need to specify the location of the Vulkan SDK if the paths aren't resolved by CMake automatically. For example (assuming the Vulkan SDK is installed in the default path):</p>
<div class="fragment"><div class="line">C:&gt; cmake -G Ninja -DTARGET_VULKAN=ON -DCMAKE_BUILD_TYPE=Release -DLLVM_DIR=$LLVM_ROOT/lib/cmake/llvm -DVulkan_LIBRARY=C:\VulkanSDK\1.3.231.1\Lib\vulkan-1.lib -DVulkan_INCLUDE_DIR=C:\VulkanSDK\1.3.231.1\Include\vulkan -S . -B build</div>
<div class="line">C:&gt; cmake --build build --config Release</div>
</div><!-- fragment --><h1><a class="anchor" id="vulkan-runtime-environment"></a>
Vulkan Runtime Environment:</h1>
<p><a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> has no direct dependency on Vulkan for code-generation, but the runtime requires a working Vulkan environment to run <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> generated code. Any valid Vulkan v1.0+ device driver should work.</p>
<p>Specifically, you'll need:</p>
<ul>
<li>A vendor specific Vulkan device driver</li>
<li>The generic Vulkan loader library</li>
</ul>
<p>For AMD &amp; NVIDIA &amp; Intel devices, download and install the latest graphics driver for your platform. Vulkan support should be included.</p>
<h2><a class="anchor" id="windows-3"></a>
Windows</h2>
<p>To build <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> AOT generators, you'll need the Vulkan SDK (specifically the Vulkan loader library and headers): <a href="https://sdk.lunarg.com/sdk/download/latest/windows/vulkan-sdk.exe">https://sdk.lunarg.com/sdk/download/latest/windows/vulkan-sdk.exe</a></p>
<p>For Vulkan device drivers, consult the appropriate hardware vendor for your device. A few common ones are listed below.</p>
<ul>
<li><a href="https://www.amd.com/en/technologies/vulkan">AMD Vulkan Driver</a></li>
<li><a href="https://developer.nvidia.com/vulkan-driver">NVIDIA Vulkan Driver</a></li>
<li><a href="https://www.intel.com/content/www/us/en/download-center/home.html">INTEL Vulkan Driver</a></li>
</ul>
<h2><a class="anchor" id="linux"></a>
Linux</h2>
<p>The Vulkan SDK packages are now being maintained by LunarG. These include the Vulkan Loader library, as well as the Vulkan Tools packages. Instructions for installing these can be found on their <a href="https://vulkan.lunarg.com/doc/view/latest/linux/getting_started_ubuntu.html">Getting Started Guide</a>.</p>
<p>Once the SDK has been installed, you need to install the appropriate driver for your device. Proprietary drivers can be installed via 'apt' using PPA's for each vendor. Examples for AMD and NVIDIA are provided below.</p>
<p>For AMD on Ubuntu v22.04: </p><div class="fragment"><div class="line">$ sudo add-apt-repository ppa:oibaf/graphics-drivers</div>
<div class="line">$ sudo apt update</div>
<div class="line">$ sudo apt upgrade</div>
<div class="line">$ sudo apt install libvulkan1 mesa-vulkan-drivers vulkan-tools</div>
</div><!-- fragment --><p>For NVIDIA on Ubuntu v22.04: </p><div class="fragment"><div class="line">$ sudo add-apt-repository ppa:graphics-drivers/ppa</div>
<div class="line">$ sudo apt update</div>
<div class="line">$ sudo apt upgrade</div>
<div class="line"># - replace ### with latest driver release (e.g. 515)</div>
<div class="line">$ sudo apt install nvidia-driver-### nvidia-settings libvulkan1 vulkan-tools</div>
</div><!-- fragment --><p>Note that only valid drivers for your system should be installed since there are reports of the Vulkan loader segfaulting just by having a non-supported driver present. Specifically, the seemingly generic <code>mesa-vulkan-drivers</code> actually includes the AMD graphics driver, which can cause problems if installed on an NVIDIA-only system.</p>
<h2><a class="anchor" id="mac"></a>
Mac</h2>
<p>You're better off using <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a>'s Metal backend instead, but it is possible to run Vulkan apps on a Mac via the MoltenVK library:</p>
<ul>
<li><a href="https://github.com/KhronosGroup/MoltenVK">MoltenVK Project</a></li>
</ul>
<p>The easiest way to get the necessary dependencies is to use the official MoltenVK SDK installer provided by LunarG:</p>
<ul>
<li><a href="https://sdk.lunarg.com/sdk/download/latest/mac/vulkan-sdk.dmg">MoltenVK SDK (Latest Release)</a></li>
</ul>
<p>Alternatively, if you have the <a href="https://brew.sh/">Homebrew</a> package manager installed for MacOS, you can use it to install the Vulkan Loader and MoltenVK compatibility layer:</p>
<div class="fragment"><div class="line">$ brew install vulkan-loader molten-vk</div>
</div><!-- fragment --><h1><a class="anchor" id="testing-your-vulkan-environment"></a>
Testing Your Vulkan Environment</h1>
<p>You can validate that everything is configured correctly by running the <code>vulkaninfo</code> app (bundled in the vulkan-utils package) to make sure your device is detected (eg):</p>
<div class="fragment"><div class="line">$ vulkaninfo</div>
<div class="line">==========</div>
<div class="line">VULKANINFO</div>
<div class="line">==========</div>
<div class="line"> </div>
<div class="line">Vulkan Instance Version: 1.3.224</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Instance Extensions: count = 19</div>
<div class="line">===============================</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">Layers: count = 10</div>
<div class="line">==================</div>
<div class="line">VK_LAYER_KHRONOS_profiles (Khronos Profiles layer) Vulkan version 1.3.224, layer version 1:</div>
<div class="line">    Layer Extensions: count = 0</div>
<div class="line">    Devices: count = 1</div>
<div class="line">        GPU id = 0 (NVIDIA GeForce RTX 3070 Ti)</div>
<div class="line">        Layer-Device Extensions: count = 1</div>
<div class="line"> </div>
<div class="line">...</div>
</div><!-- fragment --><p>Make sure everything looks correct before continuing!</p>
<h1><a class="anchor" id="targetting-vulkan"></a>
Targetting Vulkan</h1>
<p>To generate <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> code for Vulkan, simply add the <code>vulkan</code> flag to your target as well as any other optional device specific features you wish to enable for <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Target Feature   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>vulkan</code>   </td><td class="markdownTableBodyNone">Enables the vulkan backend    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>vk_int8</code>   </td><td class="markdownTableBodyNone">Allows 8-bit integer storage types to be used    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>vk_int16</code>   </td><td class="markdownTableBodyNone">Allows 16-bit integer storage types to be used    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>vk_int64</code>   </td><td class="markdownTableBodyNone">Allows 64-bit integer storage types to be used    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>vk_float16</code>   </td><td class="markdownTableBodyNone">Allows 16-bit floating-point values to be used for computation    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>vk_float64</code>   </td><td class="markdownTableBodyNone">Allows 64-bit floating-point values to be used for computation    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>vk_v10</code>   </td><td class="markdownTableBodyNone">Generates code compatible with the Vulkan v1.0+ API    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>vk_v12</code>   </td><td class="markdownTableBodyNone">Generates code compatible with the Vulkan v1.2+ API    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>vk_v13</code>   </td><td class="markdownTableBodyNone">Generates code compatible with the Vulkan v1.3+ API   </td></tr>
</table>
<p>Note that 32-bit integer and floating-point types are always available. All other optional device features are off by default (since they are not required by the Vulkan API, and thus must be explicitly enabled to ensure that the code being generated will be compatible with the device and API version being used for execution).</p>
<p>For AOT generators add <code>vulkan</code> (and any other flags you wish to use) to the target command line option:</p>
<div class="fragment"><div class="line">$ ./lesson_15_generate -g my_first_generator -o . target=host-vulkan-vk_int8-vk_int16</div>
</div><!-- fragment --><p>For JIT apps use the <code>HL_JIT_TARGET</code> environment variable:</p>
<div class="fragment"><div class="line">$ HL_JIT_TARGET=host-vulkan-vk_int8-vk_int16 ./tutorial/lesson_01_basics</div>
</div><!-- fragment --><h1><a class="anchor" id="useful-runtime-environment-variables"></a>
Useful Runtime Environment Variables</h1>
<p>To modify the default behavior of the runtime, the following environment variables can be used to adjust the configuration of the Vulkan backend at execution time:</p>
<p><code>HL_VK_LAYERS=...</code> will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to choose a suitable Vulkan instance that supports the given list of layers. If not set, <code>VK_INSTANCE_LAYERS=...</code> will be used instead. If neither are present, <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> will use the first Vulkan compute device it can find. Multiple layers can be specified using the appropriate environment variable list delimiter (<code>:</code> on Linux/OSX/Posix, or <code>;</code> on Windows).</p>
<p><code>HL_VK_DEVICE_TYPE=...</code> will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to choose which type of device to select for creating the Vulkan instance. Valid options are 'gpu', 'discrete-gpu', 'integrated-gpu', 'virtual-gpu', or 'cpu'. If not set, <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> will search for the first 'gpu' like device it can find, or fall back to the first compute device it can find.</p>
<p><code>HL_VK_ALLOC_CONFIG=...</code> will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to configure the Vulkan memory allocator use the given constraints specified as 5x integer values separated by the appropriate environment variable list delimiter (e.g. <code>N:N:N:N:N</code> on Linux/OSX/Posix, or <code>N;N;N;N;N</code> on Windows). These values correspond to <code>maximum_pool_size</code>, <code>minimum_block_size</code>, <code>maximum_block_size</code>, <code>maximum_block_count</code> and <code>nearest_multiple</code>.</p>
<p>The <code>maximum_pool_size</code> constraint will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to configure the Vulkan memory allocator to never request more than N megabytes for the entire pool of allocations for the context. This includes all resource blocks used for suballocations. Setting this to a non-zero value will limit the amount device memory used by <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a>, which may be useful when other applications and frameworks are competing for resources. Default is 0 ... meaning no limit.</p>
<p>The <code>minimum_block_size</code> constraint will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to configure the Vulkan memory allocator to always request a minimum of N megabytes for a resource block, which will be used as a pool for suballocations. <br  />
 Increasing this value may improve performance while sacrificing the amount of available device memory. Default is 32MB.</p>
<p>The <code>maximum_block_size</code> constraint will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to configure the Vulkan memory allocator to never exceed a maximum of N megabytes for a resource block. Decreasing this value may free up more memory but may impact performance, and/or restrict allocations to be unusably small. Default is 0 ... meaning no limit.</p>
<p>The <code>maximum_block_count</code> constraint will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to configure the Vulkan memory allocator to never exceed a total of N block allocations. <br  />
 Decreasing this value may free up more memory but may impact performance, and/or restrict allocations. Default is 0 ... meaning no limit.</p>
<p>The <code>nearest_multiple</code> constraint will tell <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> to configure the Vulkan memory allocator to always round up the requested allocation sizes to the given integer value. This is useful for architectures that require specific alignments for subregions allocated within a block. Default is 32 ... setting this to zero means no constraint.</p>
<h1><a class="anchor" id="debug-environment-variables"></a>
Debug Environment Variables</h1>
<p>The following environment variables may be useful for tracking down potential issues related to Vulkan:</p>
<p><code>HL_DEBUG_CODEGEN=3</code> will print out debug info that includees the SPIR-V code generator used for Vulkan while it is compiling.</p>
<p><code>HL_SPIRV_DUMP_FILE=...</code> specifies a file to dump the binary SPIR-V generated during compilation. Useful for debugging CodeGen issues. Can be inspected, validated and disassembled via the SPIR-V tools:</p>
<p><a href="https://github.com/KhronosGroup/SPIRV-Tools">https://github.com/KhronosGroup/SPIRV-Tools</a></p>
<p>In addition to the SPIR-V Tools, you may also wish to install the Khronos Validation Layers which provide an exhaustive suite of runtime checks that can be injected by adding <code>VK_LAYER_KHRONOS_validation</code> to the <code>VK_INSTANCE_LAYERS=</code> environment variable.</p>
<p>To install the validation layers and the SPIR-V tools on Ubuntu v22.04:</p>
<div class="fragment"><div class="line">$ sudo apt install vulkan-validationlayers vulkan-validationlayers-dev spirv-tools</div>
</div><!-- fragment --><p>To test the validation layer, you can prepend your shell command for any Vulkan enabled binary with the appropriate environment settings. For example, you can run one of the JIT-enabled correctness tests w/debug output and validation layers enabled like so:</p>
<div class="fragment"><div class="line">$ VK_INSTANCE_LAYERS=VK_LAYER_KHRONOS_validation HL_JIT_TARGET=host-vulkan-vk_int8-vk_int16-vk_int64-vk_float16-vk_float64-vk_v13-debug ./build/test/correctness/correctness_hello_gpu</div>
</div><!-- fragment --><h1><a class="anchor" id="current-status"></a>
Current Status</h1>
<p>All correctness tests are now passing on tested configs for Linux &amp; Windows using the target <code>host-vulkan-vk_int8-vk_int16-vk_int64-vk_float16-vk_float64-vk_v13</code> on LLVM v14.x.</p>
<p>MacOS passes most tests but encounters internal MoltenVK code translation issues for wide vectors, and ambiguous function calls.</p>
<p>Python apps, tutorials and correctness tests are now passing, but the AOT cases are skipped since the runtime environment needs to be customized to locate the platform specific Vulkan loader library.</p>
<p>Android platform support is currently being worked on.</p>
<h1><a class="anchor" id="caveats"></a>
Caveats:</h1>
<ul>
<li>Other than 32-bit floats and integers, every other data type is optional per the Vulkan spec</li>
<li>Float 64-bit types can be enabled, but there aren't any native math functions available in SPIR-V</li>
<li>Only one dynamically sized shared memory allocation can be used, but any number of fixed sized allocation are supported (up to the maximum amount allowed by the device)</li>
</ul>
<h1><a class="anchor" id="known-todo"></a>
Known TODO:</h1>
<ul>
<li>Performance tuning of CodeGen and Runtime</li>
<li>More platform support (Android is work-in-progress, RISC-V, etc)</li>
<li>Adapt unsupported types to supported types (if missing vk_int8 then promote to uint32_t)?</li>
<li>Better debugging utilities using the Vulkan debug hooks.</li>
<li>Allow debug symbols to be stripped from SPIR-V during codegen to reduce memory overhead for large kernels.</li>
<li>Investigate floating point rounding and precision (v1.3 adds more controls)</li>
<li>Investigate memory model usage (can <a class="el" href="namespace_halide.html" title="This file defines the class FunctionDAG, which is our representation of a Halide pipeline,...">Halide</a> gain anything from these?) </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
