<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>
 Auto-Scheduler
</title>
<link rel="stylesheet" type="text/css" href="../assets/css/highlight.css">
<style>

a:visited {
color: #000000;
}

a:link {
color: #000000;
}

a:hover {
color: #aa0000;
}

</style>
</head>
<body class="hl" style="background-color: #444444; font-family: Helvetica, Arial, sans-serif;">
<script>
function toggle(id) {
    e = document.getElementById(id);
    show = document.getElementById(id + '-show');
    if (e.style.display != 'none') {
        e.style.display = 'none';
        show.innerHTML = "// Click to show output ...";
    } else {
        e.style.display = 'block';
        show.innerHTML = "// Click to hide output ...";
    }
    return false;
}
</script>
<div>
<style scoped>
@import "../assets/css/bootstrap.css";
</style>
<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="/index.html">Halide</a>
      <div class="nav-collapse">
        <ul class="nav">
          <li><a href="/index.html#gettingstarted">Getting Started</a></li>
          <li><a href="/tutorials/tutorial_introduction.html">Tutorials</a></li>
          <li><a href="/index.html#publications">Publications</a></li>
          <li><a href="/index.html#resources">Resources</a></li>
          <li class="divider-vertical"></li>
          <li><a href="/docs">Docs</a></li>
          <li><a href="http://github.com/halide/Halide/issues">Bugs</a></li>
          <li><a href="http://github.com/halide/Halide/wiki">Wiki</a></li>
          <li class="divider-vertical"></li>
          <li><a href="http://stackoverflow.com/questions/tagged/halide"><i class="fa fa-stack-overflow"></i>/#halide</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>

<div style='position:relative; width:900pt; top:60px;'>
<div style="width:200px; float:left; ">
<a href="tutorial_introduction.html" style="text-decoration:none;" ><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px;
background-color: #dddddd; 
text-align: left; ">
<b>
00
&nbsp</b>
Introduction
</div>
</span>
</a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_01_basics.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
01
&nbsp</b>
 Getting started with Funcs, Vars, and Exprs
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_02_input_image.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
02
&nbsp</b>
 Processing images
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_03_debugging_1.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
03
&nbsp</b>
 Inspecting the generated code
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_04_debugging_2.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
04
&nbsp</b>
 Debugging with tracing, print, and print_when
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_05_scheduling_1.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
05
&nbsp</b>
 Vectorize, parallelize, unroll and tile your code
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_06_realizing_over_shifted_domains.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
06
&nbsp</b>
 Realizing Funcs over arbitrary domains
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_07_multi_stage_pipelines.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
07
&nbsp</b>
 Multi-stage pipelines
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_08_scheduling_2.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
08
&nbsp</b>
 Scheduling multi-stage pipelines
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_09_update_definitions.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
09
&nbsp</b>
 Multi-pass Funcs, update definitions, and reductions
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_10_aot_compilation_generate.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
10
&nbsp</b>
 AOT compilation part 1
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_10_aot_compilation_run.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
10
&nbsp</b>
 AOT compilation part 2
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_11_cross_compilation.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
11
&nbsp</b>
 Cross-compilation
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_12_using_the_gpu.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
12
&nbsp</b>
 Using the GPU
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_13_tuples.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
13
&nbsp</b>
 Tuples
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_14_types.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
14
&nbsp</b>
 The Halide type system
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_15_generators.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
15
&nbsp</b>
 Generators part 1
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_15_generators_usage.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
15
&nbsp</b>
 Generators part 2
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_16_rgb_generate.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
16
&nbsp</b>
 RGB images and memory layouts part 1
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_16_rgb_run.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
16
&nbsp</b>
 RGB images and memory layouts part 2
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_17_predicated_rdom.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
17
&nbsp</b>
 Reductions over non-rectangular domains
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_18_parallel_associative_reductions.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
18
&nbsp</b>
 Factoring an associative reduction using rfactor
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_19_wrapper_funcs.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
19
&nbsp</b>
 Wrapper Funcs
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_20_cloning_funcs.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
20
&nbsp</b>
 Cloning Funcs
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_21_auto_scheduler_generate.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; padding-right:40px; background-color: #ffffff; color: #000000; text-align: left; ">
<b>
21
&nbsp</b>
 Auto-Scheduler
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_21_auto_scheduler_run.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
21
&nbsp</b>
 Auto-Scheduler
</div></span></a>
</div>
<div style="position:relative; margin-left:260px; padding:20px; background-color: #ffffff;">
<pre class="hl">
<span class="hl slc">// Halide tutorial lesson 21: Auto-Scheduler</span>

<span class="hl slc">// So far we have written Halide schedules by hand, but it is also possible to</span>
<span class="hl slc">// ask Halide to suggest a reasonable schedule. We call this auto-scheduling.</span>
<span class="hl slc">// This lesson demonstrates how to use the autoscheduler to generate a</span>
<span class="hl slc">// copy-pasteable CPU schedule that can be subsequently improved upon.</span>

<span class="hl slc">// On linux or os x, you can compile and run it like so:</span>

<span class="hl slc">// g++ lesson_21_auto_scheduler_generate.cpp &lt;path/to/tools/halide_image_io.h&gt;/GenGen.cpp -g -std=c++17 -fno-rtti -I &lt;path/to/Halide.h&gt; -L &lt;path/to/libHalide.so&gt; -lHalide -lpthread -ldl -o lesson_21_generate</span>
<span class="hl slc">// export LD_LIBRARY_PATH=&lt;path/to/libHalide.so&gt;   # For linux</span>
<span class="hl slc">// export DYLD_LIBRARY_PATH=&lt;path/to/libHalide.dylib&gt; # For OS X</span>
<span class="hl slc">// ./lesson_21_generate -o . -g auto_schedule_gen -f auto_schedule_false -e static_library,h,schedule target=host auto_schedule=false</span>
<span class="hl slc">// ./lesson_21_generate -o . -g auto_schedule_gen -f auto_schedule_true -e static_library,h,schedule -p &lt;path/to/libautoschedule_mullapudi2016.so&gt; -S Mullapudi2016 target=host autoscheduler=Mullapudi2016 autoscheduler.parallelism=32 autoscheduler.last_level_cache_size=16777216 autoscheduler.balance=40</span>
<span class="hl slc">// g++ lesson_21_auto_scheduler_run.cpp -std=c++17 -I &lt;path/to/Halide.h&gt; -I &lt;path/to/tools/halide_image_io.h&gt; auto_schedule_false.a auto_schedule_true.a -ldl -lpthread -o lesson_21_run</span>
<span class="hl slc">// ./lesson_21_run</span>

<span class="hl slc">// If you have the entire Halide source tree, you can also build it by</span>
<span class="hl slc">// running:</span>
<span class="hl slc">//    make tutorial_lesson_21_auto_scheduler_run</span>
<span class="hl slc">// in a shell with the current directory at the top of the halide</span>
<span class="hl slc">// source tree.</span>

<span class="hl ppc">#include</span> <span class="hl pps">&quot;Halide.h&quot;</span><span class="hl ppc"></span>
<span class="hl ppc">#include &lt;stdio.h&gt;</span>

<span class="hl kwa">using namespace</span> Halide<span class="hl opt">;</span>

<span class="hl slc">// We will define a generator to auto-schedule.</span>
<span class="hl kwc">class</span> AutoScheduled <span class="hl opt">:</span> <span class="hl kwc">public Halide</span><span class="hl opt">::</span>Generator<span class="hl opt">&lt;</span>AutoScheduled<span class="hl opt">&gt; {</span>
<span class="hl kwc">public</span><span class="hl opt">:</span>
    Input<span class="hl opt">&lt;</span>Buffer<span class="hl opt">&lt;</span><span class="hl kwb">float</span><span class="hl opt">,</span> <span class="hl num">3</span><span class="hl opt">&gt;&gt;</span> input<span class="hl opt">{</span><span class="hl str">&quot;input&quot;</span><span class="hl opt">};</span>
    Input<span class="hl opt">&lt;</span><span class="hl kwb">float</span><span class="hl opt">&gt;</span> factor<span class="hl opt">{</span><span class="hl str">&quot;factor&quot;</span><span class="hl opt">};</span>

    Output<span class="hl opt">&lt;</span>Buffer<span class="hl opt">&lt;</span><span class="hl kwb">float</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">&gt;&gt;</span> output1<span class="hl opt">{</span><span class="hl str">&quot;output1&quot;</span><span class="hl opt">};</span>
    Output<span class="hl opt">&lt;</span>Buffer<span class="hl opt">&lt;</span><span class="hl kwb">float</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">&gt;&gt;</span> output2<span class="hl opt">{</span><span class="hl str">&quot;output2&quot;</span><span class="hl opt">};</span>

    Expr <span class="hl kwd">sum3x3</span><span class="hl opt">(</span>Func f<span class="hl opt">,</span> Var x<span class="hl opt">,</span> Var y<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">f</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) +</span> <span class="hl kwd">f</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y<span class="hl opt">) +</span> <span class="hl kwd">f</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) +</span>
               <span class="hl kwd">f</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) +</span> <span class="hl kwd">f</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) +</span> <span class="hl kwd">f</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) +</span>
               <span class="hl kwd">f</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) +</span> <span class="hl kwd">f</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y<span class="hl opt">) +</span> <span class="hl kwd">f</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwb">void</span> <span class="hl kwd">generate</span><span class="hl opt">() {</span>
        <span class="hl slc">// For our algorithm, we&apos;ll use Harris corner detection.</span>
        Func in_b <span class="hl opt">=</span> <span class="hl kwc">BoundaryConditions</span><span class="hl opt">::</span><span class="hl kwd">repeat_edge</span><span class="hl opt">(</span>input<span class="hl opt">);</span>

        <span class="hl kwd">gray</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl num">0.299</span>f <span class="hl opt">*</span> <span class="hl kwd">in_b</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">) +</span> <span class="hl num">0.587</span>f <span class="hl opt">*</span> <span class="hl kwd">in_b</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">) +</span> <span class="hl num">0.114</span>f <span class="hl opt">*</span> <span class="hl kwd">in_b</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">);</span>

        <span class="hl kwd">Iy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) * (-</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) * (</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span>
                   <span class="hl kwd">gray</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) * (-</span><span class="hl num">2.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) * (</span><span class="hl num">2.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span>
                   <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) * (-</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) * (</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">);</span>

        <span class="hl kwd">Ix</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) * (-</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) * (</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span>
                   <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y<span class="hl opt">) * (-</span><span class="hl num">2.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y<span class="hl opt">) * (</span><span class="hl num">2.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span>
                   <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) * (-</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">) +</span> <span class="hl kwd">gray</span><span class="hl opt">(</span>x <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> y <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) * (</span><span class="hl num">1.0</span>f <span class="hl opt">/</span> <span class="hl num">12</span><span class="hl opt">);</span>

        <span class="hl kwd">Ixx</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">Ix</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) *</span> <span class="hl kwd">Ix</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">Iyy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">Iy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) *</span> <span class="hl kwd">Iy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">Ixy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">Ix</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) *</span> <span class="hl kwd">Iy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">Sxx</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">sum3x3</span><span class="hl opt">(</span>Ixx<span class="hl opt">,</span> x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">Syy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">sum3x3</span><span class="hl opt">(</span>Iyy<span class="hl opt">,</span> x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">Sxy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">sum3x3</span><span class="hl opt">(</span>Ixy<span class="hl opt">,</span> x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">det</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">Sxx</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) *</span> <span class="hl kwd">Syy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) -</span> <span class="hl kwd">Sxy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) *</span> <span class="hl kwd">Sxy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">trace</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">Sxx</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) +</span> <span class="hl kwd">Syy</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">harris</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">det</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) -</span> <span class="hl num">0.04</span>f <span class="hl opt">*</span> <span class="hl kwd">trace</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) *</span> <span class="hl kwd">trace</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">output1</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">harris</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
        <span class="hl kwd">output2</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> factor <span class="hl opt">*</span> <span class="hl kwd">harris</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwb">void</span> <span class="hl kwd">schedule</span><span class="hl opt">() {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">using_autoscheduler</span><span class="hl opt">()) {</span>
            <span class="hl slc">// The autoscheduler requires estimates on all the input/output</span>
            <span class="hl slc">// sizes and parameter values in order to compare different</span>
            <span class="hl slc">// alternatives and decide on a good schedule.</span>

            <span class="hl slc">// To provide estimates (min and extent values) for each dimension</span>
            <span class="hl slc">// of the input images (&apos;input&apos;, &apos;filter&apos;, and &apos;bias&apos;), we use the</span>
            <span class="hl slc">// set_estimates() method. set_estimates() takes in a list of</span>
            <span class="hl slc">// (min, extent) of the corresponding dimension as arguments.</span>
            input<span class="hl opt">.</span><span class="hl kwd">set_estimates</span><span class="hl opt">({{</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">1024</span><span class="hl opt">}, {</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">1024</span><span class="hl opt">}, {</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">3</span><span class="hl opt">}});</span>

            <span class="hl slc">// To provide estimates on the parameter values, we use the</span>
            <span class="hl slc">// set_estimate() method.</span>
            factor<span class="hl opt">.</span><span class="hl kwd">set_estimate</span><span class="hl opt">(</span><span class="hl num">2.0</span>f<span class="hl opt">);</span>

            <span class="hl slc">// To provide estimates (min and extent values) for each dimension</span>
            <span class="hl slc">// of pipeline outputs, we use the set_estimates() method. set_estimates()</span>
            <span class="hl slc">// takes in a list of (min, extent) for each dimension.</span>
            output1<span class="hl opt">.</span><span class="hl kwd">set_estimates</span><span class="hl opt">({{</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">1024</span><span class="hl opt">}, {</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">1024</span><span class="hl opt">}});</span>
            output2<span class="hl opt">.</span><span class="hl kwd">set_estimates</span><span class="hl opt">({{</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">1024</span><span class="hl opt">}, {</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">1024</span><span class="hl opt">}});</span>

            <span class="hl slc">// Technically, the estimate values can be anything, but the closer</span>
            <span class="hl slc">// they are to the actual use-case values, the better the generated</span>
            <span class="hl slc">// schedule will be.</span>

            <span class="hl slc">// To auto-schedule the pipeline, we don&apos;t have to do anything else:</span>
            <span class="hl slc">// every Generator implicitly has a GeneratorParam named &quot;auto_scheduler.name&quot;;</span>
            <span class="hl slc">// if this is set to the name of the Autoscheduler we want to use, Halide will</span>
            <span class="hl slc">// apply it to all of our pipeline&apos;s outputs automatically.</span>

            <span class="hl slc">// Every Generator also implicitly has additional, optional GeneratorParams that are</span>
            <span class="hl slc">// dependent on the specific Autoscheduler select, which allows you to specify</span>
            <span class="hl slc">// characteristics of the machine architecture</span>
            <span class="hl slc">// for the autoscheduler; it&apos;s generally specified in your Makefile.</span>
            <span class="hl slc">// If none is specified, the default machine parameters for a generic CPU</span>
            <span class="hl slc">// architecture will be used by the autoscheduler.</span>

            <span class="hl slc">// Let&apos;s see some arbitrary but plausible values for the machine parameters</span>
            <span class="hl slc">// for the Mullapudi2016 Autoscheduler:</span>
            <span class="hl slc">//</span>
            <span class="hl slc">//      autoscheduler=Mullapudi2016</span>
            <span class="hl slc">//      autoscheduler.parallelism=32</span>
            <span class="hl slc">//      autoscheduler.last_level_cache_size=16777216</span>
            <span class="hl slc">//      autoscheduler.balance=40</span>
            <span class="hl slc">//</span>
            <span class="hl slc">// These are the maximum level of parallelism</span>
            <span class="hl slc">// available, the size of the last-level cache (in bytes), and the ratio</span>
            <span class="hl slc">// between the cost of a miss at the last level cache and the cost</span>
            <span class="hl slc">// of arithmetic on the target architecture, in that order.</span>

            <span class="hl slc">// Note that when using the autoscheduler, no schedule should have</span>
            <span class="hl slc">// been applied to the pipeline; otherwise, the autoscheduler will</span>
            <span class="hl slc">// throw an error. The current autoscheduler cannot handle a</span>
            <span class="hl slc">// partially-scheduled pipeline.</span>

            <span class="hl slc">// If HL_DEBUG_CODEGEN is set to 3 or greater, the schedule will be dumped</span>
            <span class="hl slc">// to stdout (along with much other information); a more useful way is</span>
            <span class="hl slc">// to add &quot;schedule&quot; to the -e flag to the Generator. (In CMake and Bazel,</span>
            <span class="hl slc">// this is done using the &quot;extra_outputs&quot; flag.)</span>

            <span class="hl slc">// The generated schedule that is dumped to file is an actual</span>
            <span class="hl slc">// Halide C++ source, which is readily copy-pasteable back into</span>
            <span class="hl slc">// this very same source file with few modifications. Programmers</span>
            <span class="hl slc">// can use this as a starting schedule and iteratively improve the</span>
            <span class="hl slc">// schedule. Note that the current autoscheduler is only able to</span>
            <span class="hl slc">// generate CPU schedules and only does tiling, simple vectorization</span>
            <span class="hl slc">// and parallelization. It doesn&apos;t deal with line buffering, storage</span>
            <span class="hl slc">// reordering, or factoring reductions.</span>

            <span class="hl slc">// At the time of writing, the autoscheduler will produce the</span>
            <span class="hl slc">// following schedule for the estimates and machine parameters</span>
            <span class="hl slc">// declared above when run on this pipeline:</span>
            <span class="hl slc">//</span>
            <span class="hl slc">// Var x_i(&quot;x_i&quot;);</span>
            <span class="hl slc">// Var x_i_vi(&quot;x_i_vi&quot;);</span>
            <span class="hl slc">// Var x_i_vo(&quot;x_i_vo&quot;);</span>
            <span class="hl slc">// Var x_o(&quot;x_o&quot;);</span>
            <span class="hl slc">// Var x_vi(&quot;x_vi&quot;);</span>
            <span class="hl slc">// Var x_vo(&quot;x_vo&quot;);</span>
            <span class="hl slc">// Var y_i(&quot;y_i&quot;);</span>
            <span class="hl slc">// Var y_o(&quot;y_o&quot;);</span>
            <span class="hl slc">//</span>
            <span class="hl slc">// Func Ix = pipeline.get_func(4);</span>
            <span class="hl slc">// Func Iy = pipeline.get_func(7);</span>
            <span class="hl slc">// Func gray = pipeline.get_func(3);</span>
            <span class="hl slc">// Func harris = pipeline.get_func(14);</span>
            <span class="hl slc">// Func output1 = pipeline.get_func(15);</span>
            <span class="hl slc">// Func output2 = pipeline.get_func(16);</span>
            <span class="hl slc">//</span>
            <span class="hl slc">// {</span>
            <span class="hl slc">//     Var x = Ix.args()[0];</span>
            <span class="hl slc">//     Ix</span>
            <span class="hl slc">//         .compute_at(harris, x_o)</span>
            <span class="hl slc">//         .split(x, x_vo, x_vi, 8)</span>
            <span class="hl slc">//         .vectorize(x_vi);</span>
            <span class="hl slc">// }</span>
            <span class="hl slc">// {</span>
            <span class="hl slc">//     Var x = Iy.args()[0];</span>
            <span class="hl slc">//     Iy</span>
            <span class="hl slc">//         .compute_at(harris, x_o)</span>
            <span class="hl slc">//         .split(x, x_vo, x_vi, 8)</span>
            <span class="hl slc">//         .vectorize(x_vi);</span>
            <span class="hl slc">// }</span>
            <span class="hl slc">// {</span>
            <span class="hl slc">//     Var x = gray.args()[0];</span>
            <span class="hl slc">//     gray</span>
            <span class="hl slc">//         .compute_at(harris, x_o)</span>
            <span class="hl slc">//         .split(x, x_vo, x_vi, 8)</span>
            <span class="hl slc">//         .vectorize(x_vi);</span>
            <span class="hl slc">// }</span>
            <span class="hl slc">// {</span>
            <span class="hl slc">//     Var x = harris.args()[0];</span>
            <span class="hl slc">//     Var y = harris.args()[1];</span>
            <span class="hl slc">//     harris</span>
            <span class="hl slc">//         .compute_root()</span>
            <span class="hl slc">//         .split(x, x_o, x_i, 256)</span>
            <span class="hl slc">//         .split(y, y_o, y_i, 128)</span>
            <span class="hl slc">//         .reorder(x_i, y_i, x_o, y_o)</span>
            <span class="hl slc">//         .split(x_i, x_i_vo, x_i_vi, 8)</span>
            <span class="hl slc">//         .vectorize(x_i_vi)</span>
            <span class="hl slc">//         .parallel(y_o)</span>
            <span class="hl slc">//         .parallel(x_o);</span>
            <span class="hl slc">// }</span>
            <span class="hl slc">// {</span>
            <span class="hl slc">//     Var x = output1.args()[0];</span>
            <span class="hl slc">//     Var y = output1.args()[1];</span>
            <span class="hl slc">//     output1</span>
            <span class="hl slc">//         .compute_root()</span>
            <span class="hl slc">//         .split(x, x_vo, x_vi, 8)</span>
            <span class="hl slc">//         .vectorize(x_vi)</span>
            <span class="hl slc">//         .parallel(y);</span>
            <span class="hl slc">// }</span>
            <span class="hl slc">// {</span>
            <span class="hl slc">//     Var x = output2.args()[0];</span>
            <span class="hl slc">//     Var y = output2.args()[1];</span>
            <span class="hl slc">//     output2</span>
            <span class="hl slc">//         .compute_root()</span>
            <span class="hl slc">//         .split(x, x_vo, x_vi, 8)</span>
            <span class="hl slc">//         .vectorize(x_vi)</span>
            <span class="hl slc">//         .parallel(y);</span>
            <span class="hl slc">// }</span>

        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl slc">// This is where you would declare the schedule you have written by</span>
            <span class="hl slc">// hand or paste the schedule generated by the autoscheduler.</span>
            <span class="hl slc">// We will use a naive schedule here to compare the performance of</span>
            <span class="hl slc">// the autoschedule with a basic schedule.</span>
            gray<span class="hl opt">.</span><span class="hl kwd">compute_root</span><span class="hl opt">();</span>
            Iy<span class="hl opt">.</span><span class="hl kwd">compute_root</span><span class="hl opt">();</span>
            Ix<span class="hl opt">.</span><span class="hl kwd">compute_root</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

<span class="hl kwc">private</span><span class="hl opt">:</span>
    Var x<span class="hl opt">{</span><span class="hl str">&quot;x&quot;</span><span class="hl opt">},</span> y<span class="hl opt">{</span><span class="hl str">&quot;y&quot;</span><span class="hl opt">},</span> c<span class="hl opt">{</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">};</span>
    Func gray<span class="hl opt">,</span> Iy<span class="hl opt">,</span> Ix<span class="hl opt">,</span> Ixx<span class="hl opt">,</span> Iyy<span class="hl opt">,</span> Ixy<span class="hl opt">,</span> Sxx<span class="hl opt">,</span> Syy<span class="hl opt">,</span> Sxy<span class="hl opt">,</span> det<span class="hl opt">,</span> trace<span class="hl opt">,</span> harris<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl slc">// As in lesson 15, we register our generator and then compile this</span>
<span class="hl slc">// file along with tools/GenGen.cpp.</span>
<span class="hl kwd">HALIDE_REGISTER_GENERATOR</span><span class="hl opt">(</span>AutoScheduled<span class="hl opt">,</span> auto_schedule_gen<span class="hl opt">)</span>

<span class="hl slc">// After compiling this file, see how to use it in</span>
<span class="hl slc">// lesson_21_auto_scheduler_run.cpp</span>
</pre>
</div></body></html>
